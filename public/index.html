<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Watranslate</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
  <script src="bower_components/watson-speech/dist/watson-speech.js"></script>
<script src="bower_components/fetch/fetch.js"></script>

</head>
<body>
  <div class="container">

    <div>
        <h2>start speaking</h2>
        <button id="button">Start Microphone Transcription</button>
        <button id="stop">Stop</button>

        <h2>Output:</h2>
        <div id="output">--</div>
        <h2>Translated version</h2>
        <div id="translated">--</div>

        <h1></h1>
        <input id="lang" type="text">
    </div>
  </div>
</body>


<script>

var voices = {
  english: "en-GB_KateVoice",
  spanish: "es-ES_LauraVoice",
  german: "de-DE_DieterVoice",
  french: "fr-FR_ReneeVoice",
  italien: "it-IT_FrancescaVoice",
  japanese: "ja-JP_EmiVoice",
  portuguese: "pt-BR_IsabelaVoice"
}

var realtoken;
document.querySelector('#button').onclick = function () {
    $.ajax({
      type:"GET",
      url:"/ssttoken",
      success:function(token){
        console.log(token);
        realtoken = token;
            var stream = WatsonSpeech.SpeechToText.recognizeMicrophone({
            token: token,
            outputElement: '#output' 
          });
          stream.on('error', function(err) {
            console.log(err);
         });
          document.querySelector('#stop').onclick = function() {
              stream.stop();
              var text = document.getElementById('output').textContent;
              translate(text);

          };
      },
      error:function(error){
        console.log(error);
      }
    });
};

function translate(text) {
  $.ajax({
      type:"GET",
      url:"/translate?text="+text,
      success:function(resp){            
        console.log(resp);
        say(resp);
      },
      error:function(error){
        console.log(error);
      }
    });
}

function say(response_text) {
  document.getElementById("translated").innerHTML=response_text;
  $.ajax({
      type:"GET",
      url:"/ttstoken",
      success:function(temptoken){
        var temp = document.getElementById("lang").value;
        var intended_language = voices[temp];
          WatsonSpeech.TextToSpeech.synthesize({
            text:response_text,
            voice: intended_language,
            token: temptoken
          });
      },
      error:function(error){
        console.log(error);
      }
    });
}

</script>


</html>

